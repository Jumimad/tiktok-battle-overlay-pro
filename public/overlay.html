<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Overlay Batalla Full Screen</title>
    <link id="main-stylesheet" rel="stylesheet" href="style.css">
</head>
<body>

<div id="fullscreen-layer"></div>

<div id="main-container">
    <div id="top-info-bar"></div>
    <div id="multi-goal-bar"></div>
    <div id="timer-display" class="hidden">00:00</div>
</div>

<div id="winner-celebration" class="hidden">
    <div id="winner-box">
        <div id="winner-title">¡Ganador!</div>
        <div id="winner-name">---</div>
    </div>
</div>

<script src="common.js"></script>
<script>
    // --- NOTA: No declaramos 'let currentSettings' aquí porque common.js ya lo hace ---

    // --- AJUSTES VISUALES DESDE CONFIG ---
    function applyLayout(layout) {
        if (!layout) return;
        const r = document.querySelector(':root');
        if(layout.overlay_padding_top !== undefined) r.style.setProperty('--pad-top', `${layout.overlay_padding_top}px`);
        if(layout.container_width !== undefined) r.style.setProperty('--cont-width', `${layout.container_width}%`);
        if(layout.bar_height !== undefined) r.style.setProperty('--bar-height', `${layout.bar_height}px`);
        if(layout.icon_size !== undefined) r.style.setProperty('--icon-size', `${layout.icon_size}px`);
        if(layout.gift_size !== undefined) r.style.setProperty('--gift-size', `${layout.gift_size}px`);
        if(layout.font_size !== undefined) r.style.setProperty('--font-size', `${layout.font_size}px`);
        if(layout.timer_top_margin !== undefined) r.style.setProperty('--timer-margin', `${layout.timer_top_margin}px`);
        if(layout.timer_font_size !== undefined) r.style.setProperty('--timer-font', `${layout.timer_font_size}px`);
    }

    // --- HELPER PARA RUTAS DE IMAGEN ---
    function fixPath(path) {
        if (!path) return '';
        if (path.startsWith('http')) return path;
        return `/local-image?path=${encodeURIComponent(path)}`;
    }

    // --- RENDERIZADO PRINCIPAL (CONFIGURACIÓN) ---
    function handleConfig(config) {
        // Asignamos a la variable global que viene de common.js
        if(typeof currentSettings !== 'undefined') currentSettings = config;

        applyLayout(config.layout);
        const l = config.layout || {};

        const multiGoalBar = document.getElementById('multi-goal-bar');
        const topInfoBar = document.getElementById('top-info-bar');
        const fullscreenLayer = document.getElementById('fullscreen-layer');

        multiGoalBar.innerHTML = '';
        if(topInfoBar) topInfoBar.innerHTML = '';
        fullscreenLayer.innerHTML = '';

        if (!config.teams) return;
        const activeTeams = config.teams.filter(t => t.active !== false);

        activeTeams.forEach((team, index) => {
            // 1. CREAR COLUMNA DE FONDO GIGANTE
            const bgCol = document.createElement('div');
            bgCol.className = 'fs-column';
            bgCol.id = `fs-bg-${team.id}`; // ID vital para el hielo
            fullscreenLayer.appendChild(bgCol);

            // 2. SEGMENTO DE BARRA
            const segment = document.createElement('div');
            segment.className = 'bar-segment';
            segment.id = `segment-${team.id}`;
            segment.style.width = (100 / activeTeams.length) + '%';

            // Fondo visual de la barra (donde también va el hielo pequeño)
            const visualBg = document.createElement('div');
            visualBg.className = 'visual-bg';
            visualBg.id = `visual-bg-${team.id}`; // ID vital para el hielo
            visualBg.style.backgroundColor = team.color;
            segment.appendChild(visualBg);

            // 3. ESTRUCTURA DE INFORMACIÓN (Surfing Wrapper)
            const surfWrapper = document.createElement('div');
            surfWrapper.className = 'surfing-wrapper';
            // Lógica de posición (Izquierda o Derecha)
            if (index === 0) surfWrapper.classList.add('surf-left-team');
            else surfWrapper.classList.add('surf-right-team');

            // --- FILA SUPERIOR: FOTO Y NOMBRE ---
            const topRow = document.createElement('div');
            topRow.className = 'info-top-row';

            const iconSrc = fixPath(team.icon);
            const htmlProfile = (l.show_team_icon !== false && team.icon)
                ? `<img src="${iconSrc}" class="player-icon" onerror="this.style.display='none'">`
                : '';

            let bgGradient = `linear-gradient(90deg, ${team.color} 50%, transparent 100%)`;
            const htmlName = `<span class="player-name" style="background: ${bgGradient}; color: white;">${team.name}</span>`;

            topRow.innerHTML = htmlProfile + htmlName;

            // --- FILA INFERIOR: REGALOS (CLUSTERS) ---
            const bottomRow = document.createElement('div');
            bottomRow.className = 'info-bottom-row';

            let htmlGifts = '';
            if (l.show_gift_icon !== false) {
                if (team.giftIcon_high) {
                    const gLow = fixPath(team.giftIcon_low);
                    const gMid = fixPath(team.giftIcon_mid);
                    const gHigh = fixPath(team.giftIcon_high);
                    htmlGifts = `
                        <div class="gift-cluster">
                            <div class="gift-item sub"><img src="${gLow}"></div>
                            <div class="gift-item sub"><img src="${gMid}"></div>
                            <div class="gift-item main"><img src="${gHigh}"></div>
                        </div>
                    `;
                } else if (team.giftIcon) {
                    htmlGifts = `<img src="${fixPath(team.giftIcon)}" class="top-gift-icon">`;
                }
            }
            bottomRow.innerHTML = htmlGifts;

            surfWrapper.appendChild(topRow);
            surfWrapper.appendChild(bottomRow);
            segment.appendChild(surfWrapper);

            // 4. PUNTAJE NUMÉRICO
            const segmentScore = document.createElement('span');
            segmentScore.className = 'segment-score';
            segmentScore.id = `bar-score-${team.id}`;
            segmentScore.innerText = '0';
            segmentScore.style.left = '20px';
            segmentScore.style.right = 'auto';
            segmentScore.style.textAlign = 'left';

            segment.appendChild(segmentScore);
            multiGoalBar.appendChild(segment);
        });

        // Aseguramos que currentScores exista antes de llamar
        if(typeof currentScores !== 'undefined') handleScores(currentScores, true);
    }

    // --- MANEJO DE PUNTUACIONES Y EFECTOS ---
    function handleScores(scores, isInitialLoad) {
        // Actualizamos variable global si existe
        if(typeof currentScores !== 'undefined') currentScores = scores;

        // Verificamos settings
        const settings = (typeof currentSettings !== 'undefined') ? currentSettings : {};
        const teams = settings.teams ? settings.teams.filter(t => t.active!==false) : [];

        if (teams.length === 0) return;

        let total = 0;
        teams.forEach(t => total += (scores[t.id] || 0));

        // =========================================================
        // LÓGICA DE HIELO (PANTALLA + BARRITA)
        // =========================================================
        if (teams.length === 2 && settings.ice_effect) {
            const t1 = teams[0];
            const t2 = teams[1];
            const s1 = scores[t1.id] || 0;
            const s2 = scores[t2.id] || 0;

            // 1. Elementos de Pantalla Completa
            const fs1 = document.getElementById(`fs-bg-${t1.id}`);
            const fs2 = document.getElementById(`fs-bg-${t2.id}`);

            // 2. Elementos de la Barrita
            const bar1 = document.getElementById(`visual-bg-${t1.id}`);
            const bar2 = document.getElementById(`visual-bg-${t2.id}`);

            // A. LIMPIEZA
            if(fs1) fs1.classList.remove('frozen');
            if(fs2) fs2.classList.remove('frozen');
            if(bar1) bar1.classList.remove('frozen');
            if(bar2) bar2.classList.remove('frozen');

            // B. APLICACIÓN
            if (total > 0 && s1 !== s2) {
                if (s1 > s2) {
                    if(fs2) fs2.classList.add('frozen');
                    if(bar2) bar2.classList.add('frozen');
                } else {
                    if(fs1) fs1.classList.add('frozen');
                    if(bar1) bar1.classList.add('frozen');
                }
            }
        }
        // =========================================================

        const basePercent = 15.0;
        const remaining = 100 - (basePercent * teams.length);

        teams.forEach(team => {
            const s = scores[team.id] || 0;
            const txt = document.getElementById(`bar-score-${team.id}`);
            const seg = document.getElementById(`segment-${team.id}`);

            if(txt) {
                const start = parseInt(txt.innerText)||0;
                if(start!==s && typeof animateValue==='function') animateValue(txt, start, s, 500);
                else txt.innerText = s;
            }
            if(seg) {
                let w = basePercent;
                if(total>0) w += (s/total)*remaining;
                else w = 100/teams.length;
                seg.style.width = w + '%';
            }
        });
    }

    // --- TEMPORIZADOR ---
    function handleTimer(s, r, p) {
        const el = document.getElementById('timer-display');
        if(s<=0 || isNaN(s)) { el.classList.add('hidden'); return; }
        el.classList.remove('hidden');
        const m = Math.floor(s/60).toString().padStart(2,'0');
        const sec = Math.floor(s%60).toString().padStart(2,'0');
        el.innerText = `${m}:${sec}`;
    }

    // --- GANADOR ---
    function handleWinner(w) {
        const el = document.getElementById('winner-celebration');
        if(w) {
            document.getElementById('winner-name').innerText = w.name;
            document.getElementById('winner-name').style.color = w.color;
            el.classList.remove('hidden');
            el.classList.add('visible');
            setTimeout(() => { el.classList.remove('visible'); el.classList.add('hidden'); }, 5000);
        } else {
            el.classList.remove('visible');
            el.classList.add('hidden');
        }
    }

    window.handleConfig = handleConfig;
    window.handleScores = handleScores;
    window.handleTimer = handleTimer;
    window.handleWinner = handleWinner;
</script>
</body>
</html>